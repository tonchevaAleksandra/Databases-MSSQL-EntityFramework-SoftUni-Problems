USE Diablo

DECLARE @UserId int= (SELECT id
                      FROM Users
                      WHERE Username = 'Stamat');
DECLARE @GameId int= (SELECT id
                      FROM Games
                      WHERE Name = 'Safflower');
DECLARE @UserGamesId int= (SELECT id
                           FROM UsersGames
                           WHERE GameId = @GameId
                             AND UserId = @UserId);
DECLARE @UserGameLevel int=(SELECT Level
                            FROM UsersGames
                            WHERE Id = @UserGamesId);
DECLARE @ItemStartLevel int= 11;
DECLARE @ItemEndLevel int=12;
DECLARE @UserCash money= (SELECT Cash
                          FROM UsersGames
                          WHERE id = @UserGamesId);
DECLARE @ItemsPrice money= (SELECT SUM(Price)
                            FROM Items
                            WHERE MinLevel BETWEEN @ItemStartLevel AND @ItemEndLevel);

IF (@UserCash >= @ItemsPrice)
    BEGIN
        BEGIN TRANSACTION
            UPDATE UsersGames
            SET Cash-=@ItemsPrice
            WHERE Id = @UserGamesId;

            INSERT INTO UserGameItems
            SELECT i.Id, @GameId
            FROM Items AS i
            WHERE i.MinLevel BETWEEN @ItemStartLevel AND @ItemEndLevel
        COMMIT
    END

SET @ItemStartLevel = 19;
SET @ItemEndLevel = 21;
SET @UserCash = (SELECT Cash
                 FROM UsersGames
                 WHERE id = @UserGamesId);
SET @ItemsPrice = (SELECT SUM(Price)
                   FROM Items
                   WHERE MinLevel BETWEEN @ItemStartLevel AND @ItemEndLevel);

IF (@UserCash >= @ItemsPrice)
    BEGIN
        BEGIN TRANSACTION
            UPDATE UsersGames
            SET Cash-=@ItemsPrice
            WHERE Id = @UserGamesId;

            INSERT INTO UserGameItems
            SELECT i.Id, @UserGamesId
            FROM Items AS i
            WHERE MinLevel BETWEEN @ItemStartLevel AND @ItemEndLevel;
        COMMIT
    END

SELECT Name
FROM Items
JOIN UserGameItems UGI ON Items.Id = UGI.ItemId
JOIN UsersGames UG ON UG.Id = UGI.UserGameId
JOIN Users U ON UG.UserId = U.Id
WHERE u.Username='Stamat' and ug.id=@UserGamesId
ORDER BY Name;